<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Show - Major Maker</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 20px;
        }
        #show-details {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .detail-item {
            margin-bottom: 10px;
        }
        .detail-item strong {
            font-weight: bold;
            margin-right: 5px;
        }
        #loading-message, #loading-dogs-message {
            text-align: center;
            font-style: italic;
            color: #777;
        }
        #error-message, #error-dogs-message {
            color: red;
            text-align: center;
            margin-top: 20px;
        }
        #dogs-in-show-section {
            margin-top: 30px;
            padding: 15px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        #dogs-in-show-list {
            list-style: none;
            padding: 0;
        }
        #dogs-in-show-list li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        #dogs-in-show-list li:last-child {
            border-bottom: none;
        }
        #dogs-in-show-list span {
            flex-grow: 1;
            margin-right: 10px;
        }
        #dogs-in-show-list select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        #save-changes-button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #28a745; /* Green save button */
            color: white;
            transition: background-color 0.3s ease;
            margin-top: 20px;
            display: block;
            width: 200px;
            margin-left: auto;
            margin-right: auto;
        }
        #save-changes-button:hover {
            background-color: #1e7e34;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>Manage Show</h1>
    <div id="loading-message">Loading show details...</div>
    <div id="show-details" style="display: none;">
        <div class="detail-item"><strong>Show Name:</strong> <span id="show-name"></span></div>
        <div class="detail-item"><strong>Date:</strong> <span id="show-date"></span></div>
        <div class="detail-item"><strong>City:</strong> <span id="show-city"></span></div>
        <div class="detail-item"><strong>State:</strong> <span id="show-state"></span></div>
        <div class="detail-item"><strong>Registration Closes:</strong> <span id="close-date"></span></div>
        </div>
    <div id="error-message" style="display: none;"></div>

    <div id="dogs-in-show-section">
        <h2>Dogs Entered in This Show</h2>
        <div id="loading-dogs-message">Loading dogs...</div>
        <ul id="dogs-in-show-list">
            </ul>
        <div id="error-dogs-message" style="display: none;"></div>
    </div>

    <button id="save-changes-button">Save Changes</button>

    <script>
        const loadingMessageElement = document.getElementById('loading-message');
        const showDetailsElement = document.getElementById('show-details');
        const errorMessageElement = document.getElementById('error-message');
        const showNameElement = document.getElementById('show-name');
        const showDateElement = document.getElementById('show-date');
        const showCityElement = document.getElementById('show-city');
        const showStateElement = document.getElementById('show-state');
        const closeDateElement = document.getElementById('close-date');

        const dogsInShowSection = document.getElementById('dogs-in-show-section');
        const loadingDogsMessageElement = document.getElementById('loading-dogs-message');
        const dogsInShowListElement = document.getElementById('dogs-in-show-list');
        const errorDogsMessageElement = document.getElementById('error-dogs-message');
        const saveChangesButton = document.getElementById('save-changes-button');

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDudaFY9ZkQthsOPkn5MKCWUV4GdJ__YEI",
            authDomain: "major-maker-580e8.firebaseapp.com",
            databaseURL: "https://major-maker-580e8-default-rtdb.firebaseio.com",
            projectId: "major-maker-580e8",
            storageBucket: "major-maker-580e8.firebasestorage.app",
            messagingSenderId: "342221542780",
            appId: "1:342221542780:web:057da75b81136edd4a40f9",
            measurementId: "G-LGWRJMMMSS"
        };
        
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const showsCollection = db.collection('Shows');
        const dogsCollection = db.collection('Dog');
        const showEntriesCollection =db.collection('ShowEntries');

        let currentShowId = null;
        let currentUserID = null;
        let allDogsData = []; // Store all dog data
        let showEntryStatuses = {}; // Object to store the selected status for each dog
        let existingShowEntries = {}; // Object to store existing show entries

        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUserID = user.uid;
                fetchDogsAndEntries();
            } else {
                currentUserID = null;
                // Handle cases where the user is not logged in (e.g., display a message)
                console.log("User is not logged in.");
                // You might want to fetch all non-retired dogs in this case or display a different UI.
                fetchAllDogs(); // Keeping this for the fallback scenario in fetchAllDogs
            }
        });

        async function fetchShowDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const currentShowId = urlParams.get('id');

            if (!currentShowId) {
                loadingMessageElement.style.display = 'none';
                errorMessageElement.textContent = 'Error: No show ID provided.';
                errorMessageElement.style.display = 'block';
                return;
            }

            try {
                const showDoc = await showsCollection.doc(currentShowId).get();

                if (showDoc.exists) {
                    const showData = showDoc.data();
                    showNameElement.textContent = showData.ShowName || 'N/A';
                    showDateElement.textContent = formatDate(showData.ShowDate) || 'N/A';
                    showCityElement.textContent = showData.ShowCity || 'N/A';
                    showStateElement.textContent = showData.ShowState || 'N/A';
                    closeDateElement.textContent = formatDate(showData.CloseDate) || 'N/A';

                    loadingMessageElement.style.display = 'none';
                    showDetailsElement.style.display = 'block';

                } else {
                    loadingMessageElement.style.display = 'none';
                    errorMessageElement.textContent = `Error: Show with ID "${currentShowId}" not found.`;
                    errorMessageElement.style.display = 'block';
                    loadingDogsMessageElement.style.display = 'none'; // Hide dog loading message as well
                }

            } catch (error) {
                console.error("Error fetching show details:", error);
                loadingMessageElement.style.display = 'none';
                errorMessageElement.textContent = `Failed to load show details: ${error.message}`;
                errorMessageElement.style.display = 'block';
                loadingDogsMessageElement.style.display = 'none'; // Hide dog loading message on error
            }
        }

        async function fetchDogsAndEntries() {
            try {
                let dogsQuery = dogsCollection.where('Retired', '!=', true);
                if (currentUserID) {
                    dogsQuery = dogsQuery.where('OwnerID', '==', currentUserID);
                }

                const dogsSnapshot = await dogsQuery.get();
                allDogsData = dogsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Fetch existing show entries for these dogs and the current show
                const entriesSnapshot = await showEntriesCollection
                    .where('DogID', 'in', allDogsData.map(dog => dog.id))
                    .where('ShowID', '==', currentShowId)
                    .get();

                existingShowEntries = {};
                entriesSnapshot.forEach(doc => {
                    existingShowEntries[doc.data().DogID] = doc.data().InterestLevel;
                });

                displayDogList();
                loadingDogsMessageElement.style.display = 'none';

            } catch (error) {
                console.error("Error fetching dogs and entries:", error);
                loadingDogsMessageElement.style.display = 'none';
                errorDogsMessageElement.textContent = `Failed to load your dogs and entries: ${error.message}`;
                errorDogsMessageElement.style.display = 'block';
            }
        }

        function displayDogList() {
            dogsInShowListElement.innerHTML = '';
            allDogsData.forEach(dog => {
                const listItem = document.createElement('li');
                const dogNameSpan = document.createElement('span');
                dogNameSpan.textContent = dog.DogRegName || 'N/A';

                const statusDropdown = document.createElement('select');
                statusDropdown.dataset.dogId = dog.id; // Store dog ID in the dropdown
                const options = ["N/A", "Interested", "Going", "Entered"];
                const interestLevel = existingShowEntries[dog.id] !== undefined ? existingShowEntries[dog.id] : 0; // Default to N/A (0) if no entry
                
                options.forEach((optionValue, index) => {
                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = optionValue;
                    option.selected = (interestLevel === index); // Select based on numerical index
                    statusDropdown.appendChild(option);
                });
                statusDropdown.addEventListener('change', (event) => {
                    const selectedText = event.target.value;
                });

                listItem.appendChild(dogNameSpan);
                listItem.appendChild(statusDropdown);
                dogsInShowListElement.appendChild(listItem);
            });
        }

        function formatDate(date) {
            if (date && date.toDate) {
                const jsDate = date.toDate();
                const year = jsDate.getFullYear();
                const month = String(jsDate.getMonth() + 1).padStart(2, '0');
                const day = String(jsDate.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } else if (typeof date === 'string') {
                return date;
            }
            return 'N/A';
        }

        async function saveShowEntries() {
            if (!currentShowId) {
                alert('Error: No show ID to save entries for.');
                return;
            }
        
            const showEntriesCollection = db.collection('ShowEntries');
        
            // Iterate through the displayed dogs and their selected statuses
            for (const dogId in showEntryStatuses) {
                const interestLevelText = showEntryStatuses[dogId];
                let interestLevel = 0; // Default to N/A
        
                switch (interestLevelText) {
                    case "Interested":
                        interestLevel = 1;
                        break;
                    case "Going":
                        interestLevel = 2;
                        break;
                    case "Entered":
                        interestLevel = 3;
                        break;
                    case "N/A":
                    default:
                        interestLevel = 0;
                        break;
                }
        
                const showEntryDocRef = showEntriesCollection
                    .where('DogID', '==', dogId)
                    .where('ShowID', '==', currentShowId)
                    .limit(1);
        
                const existingEntrySnapshot = await showEntryDocRef.get();
        
                if (interestLevel > 0) {
                    // If interest level is greater than N/A, create or update
                    if (!existingEntrySnapshot.empty) {
                        // Update existing document
                        const existingDocId = existingEntrySnapshot.docs[0].id;
                        await showEntriesCollection.doc(existingDocId).update({
                            InterestLevel: interestLevel
                        });
                    } else {
                        // Create a new document
                        await showEntriesCollection.add({
                            DogID: dogId,
                            ShowID: currentShowId,
                            InterestLevel: interestLevel
                        });
                    }
                } else {
                    // If interest level is N/A (0), delete existing entry if it exists
                    if (!existingEntrySnapshot.empty) {
                        const existingDocId = existingEntrySnapshot.docs[0].id;
                        await showEntriesCollection.doc(existingDocId).delete();
                    }
                    // Do nothing if no entry exists for N/A
                }
            }
        
            alert('Show entry statuses saved successfully!');
        }

        saveChangesButton.addEventListener('click', saveShowEntries);

        // Fetch show details and then all dogs when the page loads
        fetchShowDetails();
    </script>
</body>
</html>
