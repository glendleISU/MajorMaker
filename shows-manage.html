<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Show - Major Maker</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 20px;
        }
        #show-details {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .detail-item {
            margin-bottom: 10px;
        }
        .detail-item strong {
            font-weight: bold;
            margin-right: 5px;
        }
        #loading-message, #loading-dogs-message {
            text-align: center;
            font-style: italic;
            color: #777;
        }
        #error-message, #error-dogs-message {
            color: red;
            text-align: center;
            margin-top: 20px;
        }
        #dogs-in-show-section {
            margin-top: 30px;
            padding: 15px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        #dogs-in-show-list {
            list-style: none;
            padding: 0;
        }
        #dogs-in-show-list li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        #dogs-in-show-list li:last-child {
            border-bottom: none;
        }
        #dogs-in-show-list span {
            flex-grow: 1;
            margin-right: 10px;
        }
        #dogs-in-show-list select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        #save-changes-button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #28a745; /* Green save button */
            color: white;
            transition: background-color 0.3s ease;
            margin-top: 20px;
            display: block;
            width: 200px;
            margin-left: auto;
            margin-right: auto;
        }
        #save-changes-button:hover {
            background-color: #1e7e34;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>Manage Show</h1>
    <div id="loading-message">Loading show details...</div>
    <div id="show-details" style="display: none;">
        <div class="detail-item"><strong>Show Name:</strong> <span id="show-name"></span></div>
        <div class="detail-item"><strong>Date:</strong> <span id="show-date"></span></div>
        <div class="detail-item"><strong>City:</strong> <span id="show-city"></span></div>
        <div class="detail-item"><strong>State:</strong> <span id="show-state"></span></div>
        <div class="detail-item"><strong>Registration Closes:</strong> <span id="close-date"></span></div>
        </div>
    <div id="error-message" style="display: none;"></div>

    <div id="dogs-in-show-section">
        <h2>Dogs Entered in This Show</h2>
        <div id="loading-dogs-message">Loading dogs...</div>
        <ul id="dogs-in-show-list">
            </ul>
        <div id="error-dogs-message" style="display: none;"></div>
    </div>

    <button id="save-changes-button">Save Changes</button>

    <script>
        const loadingMessageElement = document.getElementById('loading-message');
        const showDetailsElement = document.getElementById('show-details');
        const errorMessageElement = document.getElementById('error-message');
        const showNameElement = document.getElementById('show-name');
        const showDateElement = document.getElementById('show-date');
        const showCityElement = document.getElementById('show-city');
        const showStateElement = document.getElementById('show-state');
        const closeDateElement = document.getElementById('close-date');

        const dogsInShowSection = document.getElementById('dogs-in-show-section');
        const loadingDogsMessageElement = document.getElementById('loading-dogs-message');
        const dogsInShowListElement = document.getElementById('dogs-in-show-list');
        const errorDogsMessageElement = document.getElementById('error-dogs-message');
        const saveChangesButton = document.getElementById('save-changes-button');

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDudaFY9ZkQthsOPkn5MKCWUV4GdJ__YEI",
            authDomain: "major-maker-580e8.firebaseapp.com",
            databaseURL: "https://major-maker-580e8-default-rtdb.firebaseio.com",
            projectId: "major-maker-580e8",
            storageBucket: "major-maker-580e8.firebasestorage.app",
            messagingSenderId: "342221542780",
            appId: "1:342221542780:web:057da75b81136edd4a40f9",
            measurementId: "G-LGWRJMMMSS"
        };
        
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const showsCollection = db.collection('Shows');
        const dogsCollection = db.collection('Dog');

        let currentShowId = null;
        let currentUserID = null;
        let allDogsData = []; // Store all dog data
        let showEntryStatuses = {}; // Object to store the selected status for each dog

        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUserID = user.uid;
                // Re-fetch the dogs now that we have the user ID
                fetchAllDogs();
            } else {
                currentUserID = null;
                // Handle cases where the user is not logged in (e.g., display a message)
                console.log("User is not logged in.");
                // You might want to fetch all non-retired dogs in this case or display a different UI.
                fetchAllDogs(); // Keeping this for the fallback scenario in fetchAllDogs
            }
        });

        async function fetchShowDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const currentShowId = urlParams.get('id');

            if (!currentShowId) {
                loadingMessageElement.style.display = 'none';
                errorMessageElement.textContent = 'Error: No show ID provided.';
                errorMessageElement.style.display = 'block';
                return;
            }

            try {
                const doc = await showsCollection.doc(currentShowId).get();

                if (doc.exists) {
                    const showData = doc.data();
                    showNameElement.textContent = showData.ShowName || 'N/A';
                    showDateElement.textContent = formatDate(showData.ShowDate) || 'N/A';
                    showCityElement.textContent = showData.ShowCity || 'N/A';
                    showStateElement.textContent = showData.ShowState || 'N/A';
                    closeDateElement.textContent = formatDate(showData.CloseDate) || 'N/A';

                    loadingMessageElement.style.display = 'none';
                    showDetailsElement.style.display = 'block';

                    // Now fetch the list of all dogs
                    fetchAllDogs();

                } else {
                    loadingMessageElement.style.display = 'none';
                    errorMessageElement.textContent = `Error: Show with ID "${currentShowId}" not found.`;
                    errorMessageElement.style.display = 'block';
                    loadingDogsMessageElement.style.display = 'none'; // Hide dog loading message as well
                }

            } catch (error) {
                console.error("Error fetching show details:", error);
                loadingMessageElement.style.display = 'none';
                errorMessageElement.textContent = `Failed to load show details: ${error.message}`;
                errorMessageElement.style.display = 'block';
                loadingDogsMessageElement.style.display = 'none'; // Hide dog loading message on error
            }
        }

        async function fetchAllDogs() {
            try {
                if (!currentUserID) {
                    console.warn("Current user ID is not available. Displaying all non-retired dogs.");
                    const snapshot = await dogsCollection
                        .where('Retired', '!=', true) // Filter out retired dogs
                        .get();
                    allDogsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    displayDogList();
                    loadingDogsMessageElement.style.display = 'none';
                    return;
                }
        
                const snapshot = await dogsCollection
                    .where('OwnerID', '==', currentUserID) // Filter by owner ID
                    .where('Retired', '!=', true)       // Filter out retired dogs
                    .get();
        
                allDogsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayDogList();
                loadingDogsMessageElement.style.display = 'none';
        
            } catch (error) {
                console.error("Error fetching dogs:", error);
                loadingDogsMessageElement.style.display = 'none';
                errorDogsMessageElement.textContent = `Failed to load your dogs: ${error.message}`;
                errorDogsMessageElement.style.display = 'block';
            }
        }

        function displayDogList() {
            dogsInShowListElement.innerHTML = '';
            allDogsData.forEach(dog => {
                const listItem = document.createElement('li');
                const dogNameSpan = document.createElement('span');
                dogNameSpan.textContent = dog.DogRegName || 'N/A';

                const statusDropdown = document.createElement('select');
                statusDropdown.dataset.dogId = dog.id; // Store dog ID in the dropdown
                const options = ["N/A", "Interested", "Going", "Entered"];
                options.forEach(optionValue => {
                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = optionValue;
                    option.selected = (showEntryStatuses[dog.id] === optionValue || optionValue === "N/A"); // Default to N/A
                    statusDropdown.appendChild(option);
                });
                statusDropdown.addEventListener('change', (event) => {
                    showEntryStatuses[event.target.dataset.dogId] = event.target.value;
                });

                listItem.appendChild(dogNameSpan);
                listItem.appendChild(statusDropdown);
                dogsInShowListElement.appendChild(listItem);
            });
        }

        function formatDate(date) {
            if (date && date.toDate) {
                const jsDate = date.toDate();
                const year = jsDate.getFullYear();
                const month = String(jsDate.getMonth() + 1).padStart(2, '0');
                const day = String(jsDate.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } else if (typeof date === 'string') {
                return date;
            }
            return 'N/A';
        }

        async function saveShowEntries() {
            if (!currentShowId) {
                alert('Error: No show ID to save entries for.');
                return;
            }

            try {
                await showsCollection.doc(currentShowId).update({
                    DogsEntered: showEntryStatuses // Save the object of dog IDs and their statuses
                });
                alert('Show entry statuses saved successfully!');
            } catch (error) {
                console.error("Error saving show entries:", error);
                alert(`Error saving show entries: ${error.message}`);
            }
        }

        saveChangesButton.addEventListener('click', saveShowEntries);

        // Fetch show details and then all dogs when the page loads
        fetchShowDetails();
    </script>
</body>
</html>
